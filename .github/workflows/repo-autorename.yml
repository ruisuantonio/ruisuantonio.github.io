name: Rename Repository and Update Redirect URL

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 0 * * *"

jobs:
  update_redirect:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Get GitHub Username
      - name: Get GitHub Username
        id: get_username
        run: |
          USERNAME=$(curl -s -H "Authorization: token ${{ secrets.AUTORENAME_TOKEN }}" \
          https://api.github.com/user | jq -r .login)
          echo "USERNAME=$USERNAME" >> $GITHUB_ENV

      # Step 2: Get Repository Name
      - name: Get Repository Name
        id: get_repo_name
        run: |
          REPO_NAME=$(curl -s -H "Authorization: token ${{ secrets.AUTORENAME_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }} | jq -r .name)
          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV

      # Step 3: Check if GitHub Pages subdomain is different from username
      - name: Check GitHub Pages Subdomain
        id: check_pages_name
        run: |
          PAGE_NAME="${{ github.repository_owner }}"
          echo "PAGE_NAME=$PAGE_NAME" >> $GITHUB_ENV

      # Step 4: Rename Repository if Necessary
      - name: Rename Repository if Needed
        if: env.PAGE_NAME != env.USERNAME
        run: |
          echo "Repository name does not match GitHub Pages subdomain. Renaming..."
          curl -X PATCH -H "Authorization: token ${{ secrets.AUTORENAME_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{"name": "'"$USERNAME"'"}' \
          https://api.github.com/repos/${{ github.repository }}

      # Step 5: Update index.mkd redirect_url with username if needed
      - name: Update Redirect URL in index.mkd
        run: |
          if [[ -f "index.mkd" ]]; then
            sed -i "s|https://github.com/[^ ]*|https://github.com/${{ env.USERNAME }}|g" index.mkd
          fi

      # Step 6: Commit and Push the Changes
      - name: Commit and Push Changes
        run: |
          git add index.mkd
          git diff --exit-code || (git commit -m "Update redirect URL to point to current GitHub username" && git push origin main)
